{"version":3,"sources":["../../src/drivers/postgresql.ts"],"sourcesContent":["import { eq, lte } from \"drizzle-orm\";\n\nimport type { Adapter, DatabaseSession, DatabaseUser } from \"lucia\";\nimport type { PgColumn, PgDatabase, PgTableWithColumns } from \"drizzle-orm/pg-core\";\nimport type { InferSelectModel } from \"drizzle-orm\";\n\nexport class DrizzlePostgreSQLAdapter implements Adapter {\n\tprivate db: PgDatabase<any, any, any>;\n\n\tprivate sessionTable: PostgreSQLSessionTable;\n\tprivate userTable: PostgreSQLUserTable;\n\n\tconstructor(\n\t\tdb: PgDatabase<any, any, any>,\n\t\tsessionTable: PostgreSQLSessionTable,\n\t\tuserTable: PostgreSQLUserTable\n\t) {\n\t\tthis.db = db;\n\t\tthis.sessionTable = sessionTable;\n\t\tthis.userTable = userTable;\n\t}\n\n\tpublic async deleteSession(sessionId: string): Promise<void> {\n\t\tawait this.db.delete(this.sessionTable).where(eq(this.sessionTable.id, sessionId));\n\t}\n\n\tpublic async deleteUserSessions(userId: string): Promise<void> {\n\t\tawait this.db.delete(this.sessionTable).where(eq(this.sessionTable.userId, userId));\n\t}\n\n\tpublic async getSessionAndUser(\n\t\tsessionId: string\n\t): Promise<[session: DatabaseSession | null, user: DatabaseUser | null]> {\n\t\tconst result = await this.db\n\t\t\t.select({\n\t\t\t\tuser: this.userTable,\n\t\t\t\tsession: this.sessionTable\n\t\t\t})\n\t\t\t.from(this.sessionTable)\n\t\t\t.innerJoin(this.userTable, eq(this.sessionTable.userId, this.userTable.id))\n\t\t\t.where(eq(this.sessionTable.id, sessionId));\n\t\tif (result.length !== 1) return [null, null];\n\t\treturn [\n\t\t\ttransformIntoDatabaseSession(result[0].session),\n\t\t\ttransformIntoDatabaseUser(result[0].user)\n\t\t];\n\t}\n\n\tpublic async getUserSessions(userId: string): Promise<DatabaseSession[]> {\n\t\tconst result = await this.db\n\t\t\t.select()\n\t\t\t.from(this.sessionTable)\n\t\t\t.where(eq(this.sessionTable.userId, userId));\n\t\treturn result.map((val) => {\n\t\t\treturn transformIntoDatabaseSession(val);\n\t\t});\n\t}\n\n\tpublic async setSession(session: DatabaseSession): Promise<void> {\n\t\tawait this.db.insert(this.sessionTable).values({\n\t\t\tid: session.id,\n\t\t\tuserId: session.userId,\n\t\t\texpiresAt: session.expiresAt,\n\t\t\t...session.attributes\n\t\t});\n\t}\n\n\tpublic async updateSessionExpiration(sessionId: string, expiresAt: Date): Promise<void> {\n\t\tawait this.db\n\t\t\t.update(this.sessionTable)\n\t\t\t.set({\n\t\t\t\texpiresAt\n\t\t\t})\n\t\t\t.where(eq(this.sessionTable.id, sessionId));\n\t}\n\n\tpublic async deleteExpiredSessions(): Promise<void> {\n\t\tawait this.db.delete(this.sessionTable).where(lte(this.sessionTable.expiresAt, new Date()));\n\t}\n}\n\nexport type PostgreSQLUserTable = PgTableWithColumns<{\n\tdialect: \"pg\";\n\tcolumns: {\n\t\tid: PgColumn<\n\t\t\t{\n\t\t\t\tname: any;\n\t\t\t\ttableName: any;\n\t\t\t\tdataType: any;\n\t\t\t\tcolumnType: any;\n\t\t\t\tdata: string;\n\t\t\t\tdriverParam: any;\n\t\t\t\tnotNull: true;\n\t\t\t\thasDefault: boolean; // must be boolean instead of any to allow default values\n\t\t\t\tenumValues: any;\n\t\t\t\tbaseColumn: any;\n\t\t\t},\n\t\t\tobject\n\t\t>;\n\t};\n\tschema: any;\n\tname: any;\n}>;\n\nexport type PostgreSQLSessionTable = PgTableWithColumns<{\n\tdialect: \"pg\";\n\tcolumns: {\n\t\tid: PgColumn<\n\t\t\t{\n\t\t\t\tdataType: any;\n\t\t\t\tnotNull: true;\n\t\t\t\tenumValues: any;\n\t\t\t\ttableName: any;\n\t\t\t\tcolumnType: any;\n\t\t\t\tdata: string;\n\t\t\t\tdriverParam: any;\n\t\t\t\thasDefault: false;\n\t\t\t\tname: any;\n\t\t\t},\n\t\t\tobject\n\t\t>;\n\t\texpiresAt: PgColumn<\n\t\t\t{\n\t\t\t\tdataType: any;\n\t\t\t\tnotNull: true;\n\t\t\t\tenumValues: any;\n\t\t\t\ttableName: any;\n\t\t\t\tcolumnType: any;\n\t\t\t\tdata: Date;\n\t\t\t\tdriverParam: any;\n\t\t\t\thasDefault: false;\n\t\t\t\tname: any;\n\t\t\t},\n\t\t\tobject\n\t\t>;\n\t\tuserId: PgColumn<\n\t\t\t{\n\t\t\t\tdataType: any;\n\t\t\t\tnotNull: true;\n\t\t\t\tenumValues: any;\n\t\t\t\ttableName: any;\n\t\t\t\tcolumnType: any;\n\t\t\t\tdata: string;\n\t\t\t\tdriverParam: any;\n\t\t\t\thasDefault: false;\n\t\t\t\tname: any;\n\t\t\t},\n\t\t\tobject\n\t\t>;\n\t};\n\tschema: any;\n\tname: any;\n}>;\n\nfunction transformIntoDatabaseSession(\n\traw: InferSelectModel<PostgreSQLSessionTable>\n): DatabaseSession {\n\tconst { id, userId, expiresAt, ...attributes } = raw;\n\treturn {\n\t\tuserId,\n\t\tid,\n\t\texpiresAt,\n\t\tattributes\n\t};\n}\n\nfunction transformIntoDatabaseUser(raw: InferSelectModel<PostgreSQLUserTable>): DatabaseUser {\n\tconst { id, ...attributes } = raw;\n\treturn {\n\t\tid,\n\t\tattributes\n\t};\n}\n"],"mappings":"AAAA,SAAS,IAAI,WAAW;AAMjB,MAAM,yBAA4C;AAAA,EAChD;AAAA,EAEA;AAAA,EACA;AAAA,EAER,YACC,IACA,cACA,WACC;AACD,SAAK,KAAK;AACV,SAAK,eAAe;AACpB,SAAK,YAAY;AAAA,EAClB;AAAA,EAEA,MAAa,cAAc,WAAkC;AAC5D,UAAM,KAAK,GAAG,OAAO,KAAK,YAAY,EAAE,MAAM,GAAG,KAAK,aAAa,IAAI,SAAS,CAAC;AAAA,EAClF;AAAA,EAEA,MAAa,mBAAmB,QAA+B;AAC9D,UAAM,KAAK,GAAG,OAAO,KAAK,YAAY,EAAE,MAAM,GAAG,KAAK,aAAa,QAAQ,MAAM,CAAC;AAAA,EACnF;AAAA,EAEA,MAAa,kBACZ,WACwE;AACxE,UAAM,SAAS,MAAM,KAAK,GACxB,OAAO;AAAA,MACP,MAAM,KAAK;AAAA,MACX,SAAS,KAAK;AAAA,IACf,CAAC,EACA,KAAK,KAAK,YAAY,EACtB,UAAU,KAAK,WAAW,GAAG,KAAK,aAAa,QAAQ,KAAK,UAAU,EAAE,CAAC,EACzE,MAAM,GAAG,KAAK,aAAa,IAAI,SAAS,CAAC;AAC3C,QAAI,OAAO,WAAW;AAAG,aAAO,CAAC,MAAM,IAAI;AAC3C,WAAO;AAAA,MACN,6BAA6B,OAAO,CAAC,EAAE,OAAO;AAAA,MAC9C,0BAA0B,OAAO,CAAC,EAAE,IAAI;AAAA,IACzC;AAAA,EACD;AAAA,EAEA,MAAa,gBAAgB,QAA4C;AACxE,UAAM,SAAS,MAAM,KAAK,GACxB,OAAO,EACP,KAAK,KAAK,YAAY,EACtB,MAAM,GAAG,KAAK,aAAa,QAAQ,MAAM,CAAC;AAC5C,WAAO,OAAO,IAAI,CAAC,QAAQ;AAC1B,aAAO,6BAA6B,GAAG;AAAA,IACxC,CAAC;AAAA,EACF;AAAA,EAEA,MAAa,WAAW,SAAyC;AAChE,UAAM,KAAK,GAAG,OAAO,KAAK,YAAY,EAAE,OAAO;AAAA,MAC9C,IAAI,QAAQ;AAAA,MACZ,QAAQ,QAAQ;AAAA,MAChB,WAAW,QAAQ;AAAA,MACnB,GAAG,QAAQ;AAAA,IACZ,CAAC;AAAA,EACF;AAAA,EAEA,MAAa,wBAAwB,WAAmB,WAAgC;AACvF,UAAM,KAAK,GACT,OAAO,KAAK,YAAY,EACxB,IAAI;AAAA,MACJ;AAAA,IACD,CAAC,EACA,MAAM,GAAG,KAAK,aAAa,IAAI,SAAS,CAAC;AAAA,EAC5C;AAAA,EAEA,MAAa,wBAAuC;AACnD,UAAM,KAAK,GAAG,OAAO,KAAK,YAAY,EAAE,MAAM,IAAI,KAAK,aAAa,WAAW,oBAAI,KAAK,CAAC,CAAC;AAAA,EAC3F;AACD;AA2EA,SAAS,6BACR,KACkB;AAClB,QAAM,EAAE,IAAI,QAAQ,WAAW,GAAG,WAAW,IAAI;AACjD,SAAO;AAAA,IACN;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACD;AACD;AAEA,SAAS,0BAA0B,KAA0D;AAC5F,QAAM,EAAE,IAAI,GAAG,WAAW,IAAI;AAC9B,SAAO;AAAA,IACN;AAAA,IACA;AAAA,EACD;AACD;","names":[]}